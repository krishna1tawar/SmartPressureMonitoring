@{
    ViewData["Title"] = "Sensor Dashboard";
}

<div class="container mt-4">
    <h2 class="text-center mb-4">📊 Smart Pressure Monitoring Dashboard</h2>

    <!-- Latest Readings Chart -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            Latest Pressure Readings
        </div>
        <div class="card-body">
            <canvas id="pressureChart" height="100"></canvas>
        </div>
    </div>

    <!-- Anomaly Table -->
    <div class="card">
        <div class="card-header bg-danger text-white">
            ⚠ Detected Anomalies
        </div>
        <div class="card-body">
            <table class="table table-striped" id="anomalyTable">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Pressure</th>
                        <th>Anomaly Score</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let chart;

    async function loadDashboard() {
        await loadLatestReadings();
        await loadAnomalies();
    }

    // ==============================
    // Load latest readings (chart)
    // ==============================
    async function loadLatestReadings() {
        const response = await fetch('/api/sensor/latest');
        const data = await response.json();

        const labels = data.map(x => new Date(x.timestamp).toLocaleTimeString());
        const values = data.map(x => x.pressure);

        if (!chart) {
            const ctx = document.getElementById('pressureChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Pressure (PSI)",
                        data: values,
                        borderWidth: 2,
                        borderColor: 'blue'
                    }]
                }
            });
        } else {
            chart.data.labels = labels;
            chart.data.datasets[0].data = values;
            chart.update();
        }
    }

    // ==============================
    // Load anomaly list
    // ==============================
    async function loadAnomalies() {
        const response = await fetch('/api/sensor/anomalies');
        const data = await response.json();

        const tbody = document.querySelector("#anomalyTable tbody");
        tbody.innerHTML = "";

        data.forEach(item => {
            const row = `
                <tr>
                    <td>${new Date(item.timestamp).toLocaleString()}</td>
                    <td>${item.pressure}</td>
                    <td>${item.anomalyScore.toFixed(3)}</td>
                </tr>`;
            tbody.innerHTML += row;
        });
    }

    // Auto-refresh every 5 seconds
    loadDashboard();
    setInterval(loadDashboard, 5000);
</script>